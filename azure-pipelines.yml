
trigger:
  - main
variables:
    tag: '$(Build.BuildId)'
    repositoryName: 'soulredouane/jesa-php'
    phpVersion: '8.2.27'
    k8sNamespace: 'jesa-med-namespace'
    jobName: 'azp-agent-job'
    sonarHostUrl: 'http://sonarqube-sonarqube-lts.sonarqube.svc.cluster.local:9000'  # Fully qualified SonarQube service URL
    sonarToken: '95ed008304496205800ee04653a3189e62c3b9db'
stages: 
  - stage: Build_And_Test
    # dependsOn: Setup_Custom_Agent
    jobs:
      
      - job: BuildTest
        pool:
          name: 'default'
          demands:
            #  - agent.name -equals dockeragent-docker-agent
            - agent.name -equals dockeragent-soul-agent
        steps:
          - script: |
              sonar-scanner \
                -Dsonar.projectKey=azure-devops \
                -Dsonar.sources=. \
                -Dsonar.host.url=$(sonarHostUrl) \
                -Dsonar.login=$(sonarToken) \
                > sonar-scan-output.txt 2>&1
            displayName: 'Run SonarQube Scan'
          # Publish scan output as an artifact
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: 'sonar-scan-output.txt'
              artifactName: 'SonarQubeScanResults'
              publishLocation: 'Container'
            displayName: 'Publish SonarQube Scan Output'
            
          - script: |
              echo "Extracting key metrics from scan output..."
              cat sonar-scan-output.txt | grep "ANALYSIS SUCCESSFUL" || echo "Scan failed, check output for details"
              # Example: Parse .scannerwork/report-task.txt if available
              if [ -f .scannerwork/report-task.txt ]; then
                cat .scannerwork/report-task.txt
                TASK_URL=$(grep "ceTaskUrl" .scannerwork/report-task.txt | cut -d'=' -f2)
                echo "##vso[task.logissue type=warning]SonarQube Task URL: $TASK_URL"
              fi
            displayName: 'Log SonarQube Metrics'
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              command: build
              repository: $(repositoryName)
              dockerfile: '**/Dockerfile'
              containerRegistry: dockerhub-registry
              tags: |
                $(tag)
          - task: Docker@2
            displayName: 'Push Docker Image'
            inputs:
              command: push
              repository: $(repositoryName)
              containerRegistry: dockerhub-registry
              tags: |
                $(tag)
                
